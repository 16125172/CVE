CVE-2017-5123
===================
Linux privilege escalation exploiting **waitid** syscall.
The exploit is brought to you by [@XeR](https://twitter.com/XeR_0x2A) and [@chaign\_c](https://twitter.com/chaign_c) from [HexpressoTeam](http://hexpresso.github.io/) for educational purposes only.
The bug was introduced the 2017-05-21 and fixed 2017-10-09, 4.14.0-rc4+ is known vulnerable.

[![asciicast](https://asciinema.org/a/BeRNWtrX27yF28CMeflqHQT0H.png)](https://asciinema.org/a/BeRNWtrX27yF28CMeflqHQT0H)

If you are a beginner/intermediate exploit writer you are encouraged to exploit yourself before reading the exploit because it would be a very good exercise with an easy exploit primitive (almost arbitrary write).  We also challenge [@LiveOverflow] (https://twitter.com/LiveOverflow) to give it a try. Here is the description:

> **oss-security:**
> Hi,
> 
> Chris Salls discovered that when the waitid() syscall in Linux kernel
> v4.13 was refactored, it accidentally stopped checking that the
> incoming argument was pointing to userspace. This allowed local
> attackers to write directly to kernel memory, which could lead to
> privilege escalation.
>
> Introduced by this commit:
> https://git.kernel.org/linus/4c48abe91be03d191d0c20cc755877da2cb35622
> 
> Fixed with this commit to mainline tree:
> https://git.kernel.org/linus/96ca579a1ecc943b75beba58bebb0356f6cc4b51
> 
> This should be fixed in the -stable free (in the future v4.13.7) soon:
> https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git/log/?h=linux- 4.13.y
> 
> Thanks,

Spoil !
-------------


> **waitid:**
> waitid -- wait for a child process to change state.
> int waitid(idtype_t idtype, id_t id, siginfo_t *infop, int options);

The kernel doesn't check if **infop** is an userland pointer, so we can overwrite memory of any kernel page with write permissions.
The fun part is that we only control partially what gets written. There are more than thousand way of exploiting this, we decided to transforme this write primitive into Null pointer dereference for that we overwrited the **have_canfork_callback** in BSS section of the kernel, this will enable an unset callback(Null) to be "called on a new task before the process is exposed".

Thx to Chris Salls and [@kees_cook](https://twitter.com/kees_cook) sharing for the CVE.

First "real world" linux kernel exploit of [@XeR](https://twitter.com/XeR_0x2A) and [@chaign\_c](https://twitter.com/chaign_c) from [HexpressoTeam](http://hexpresso.github.io/).

> chaignc@hexpresso.team
> xer+cve-2017-5123@hexpresso.team
2017-10-22
